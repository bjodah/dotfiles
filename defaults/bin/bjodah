#!/bin/bash
# -*- mode: shell-script-mode -*-
#
# The curly braces on the line below allows us to edit this file without worrying
# if doing so while the script is running.
{
    IMAGE=bjodahimg20dot:21.8.a
    MOUNT_HOME=0
    show_help(){
        echo "Usage:"
        echo "--image     name of containerimage, default: $IMAGE"
        echo ""
        echo "Example:"
        echo ' $ bjodah -- emacs ~/.bashrc '
    }
    declare -a PODMAN_ARGS
    while [ $# -gt 0 ]; do
        case "$1" in
            -h|--help|\?)
                show_help
                exit 0
                ;;
            --image)
                shift
                IMAGE=$1
                shift
                ;;
            --mount-home)
                MOUNT_HOME=1
                shift
                ;;
            --)
                shift
                break
                ;;
            *)
                PODMAN_ARGS+=("$1")
                shift
                ;;
                # show_help
                # exit 1
                # ;;
        esac
    done

    if [ $# -eq 0 ]; then
        >&2 echo "No command to execute, exiting."
        exit 1
    fi
    if [[ $MOUNT_HOME == 1 ]]; then
        cd HOME
        PODMAN_ARGS+=("-e HOME")
        PRE_CMD="ln -s ~/.ssh /root/.ssh; ln -s ~/.gnupg /root/.gnupg;"
    fi

#           --user $UID:$GID \
#	   -e LOGNAME \
    set -x
    podman run \
           ${PODMAN_ARGS[@]} \
           -e TERM=xterm-256color\
           -e DISPLAY\
           -v /tmp/.X11-unix:/tmp/.X11-unix:rw\
           -v "$PWD":"$PWD" \
           -w "$PWD" \
           --detach-keys=ctrl-\] \
           --security-opt seccomp=unconfined \
           --rm \
           --name "bjodah" \
           -it ${IMAGE} \
           bash -c "$PRE_CMD $@"
    exit
}
